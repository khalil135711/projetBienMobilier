<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<style>
/*
Included google fonts:
font-family: 'Comfortaa', cursive;
font-family: 'Poiret One', cursive;
font-family: 'Sedgwick Ave', cursive;
font-family: 'VT323', monospace;
font-family: 'Gloria Hallelujah', cursive;
*/



body {
  background: lightgrey;  
  font-family: 'Comfortaa', cursive;
  color: black;

}

#contentArea {
  padding-top: 2%;
  padding-left: 15%;
  padding-right: 15%;
}

h1 {
}

#results {
  
}

.stylish-input-group .form-control{
	border-right:0; 
	box-shadow:0 0 0; 
	border-color:#ccc;
}

#files {
  margin: 1rem;
}

.tab-content {
  border: solid 5px white;
}

button{
    border:0;
    border-radius: 15px;
    background:white;
    margin: 1rem;
}

button:hover {
  color: inherit; /* general colors for links too */
  text-decoration: none; /* no underline */
  font-weight: bold;
}

a {
  color: inherit; /* general colors for links too */
  text-decoration: none; /* no underline */
}
a:hover {
  color: inherit; /* general colors for links too */
  text-decoration: none; /* no underline */
  font-weight: bold;
}

.hidden {
  display: none;
}

.footer {
  font-size: small;
  padding-top: 50px;
  padding-left: 15%;
  padding-right: 15%;
  width: 100%;
}



</style>
<body>
	<div class="container-fluid ">
		<div id="contentArea" class="">
			<!-- Centered Tabs -->
		<h1>vCard conform QR Code generator</h1>
		 <br>
		
		<!-- Nav tabs -->
		<ul class="nav nav-tabs" role="tablist">
		  <li class="nav-item">
		    <a class="nav-link active" data-toggle="tab" href="#singleQr" role="tab">Single QR Code by form</a>
		  </li>
		  <li class="nav-item">
		    <a class="nav-link" data-toggle="tab" id="navMultiQr" href="#multipleQr" role="tab">Multiple QR Codes from CSV file</a>
		  </li>
		</ul>

		<!-- Tab panes -->
		<div class="tab-content">
			<br>
			<div class="tab-pane active" id="singleQr" role="tabpanel">
				<div class="row" >
				  	<div class="col-xs-12 col-sm-6">
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="title" class="control-label">Title</label>
					      <input type="text" class="form-control" name="title" id="title" placeholder="Enter title e.g. Dr.">    
					    </div>
					    <div class="form-group col-xs-6 col-sm-12"> 
					      <label for="FirstN" class="control-label">First name</label>
					      <input type="text" class="form-control" name="FirstN" id="FirstN" placeholder="Enter First Name">
					    </div>
					    <div class="form-group col-xs-6 col-sm-12">  
					      <label for="LastN" class="control-label">Last name</label>
					      <input type="text" class="form-control" name="LastN" id="LastN" placeholder="Enter Last Name">
					    </div>
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">Jobtitle</label>
					      <input type="text" class="form-control" name="TITLE" id="TITLE" placeholder="Jobtitle">
					    </div>
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">Company</label>
					      <input type="text" class="form-control" name="ORG" id="ORG" placeholder="Company">
					    </div>
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">Website</label>
					      <input type="text" class="form-control" name="URL" id="URL" placeholder="Website">
					    </div>
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="address" class="control-label">Address</label>
					      <input type="text" class="form-control" name="address_street" id="address_street" placeholder="Your street">
					    </div>
					    <div class="form-group col-xs-6 col-sm-12">
					      <input type="text" class="form-control" name="address_zip" id="address_zip" placeholder="Your zip code">
					    </div>
					    <div class="form-group col-xs-6 col-sm-12">
					      <input type="text" class="form-control" name="address_city" id="address_city" placeholder="Your city">
					    </div>
				    </div>
				    <div class="col-xs-12 col-sm-6">
				    	<div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">Phone (landline)</label>
					      <input type="text" class="form-control" name="TEL;type=WORK" id="TEL;type=WORK" placeholder="Phone">
					    </div>
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">Phone (mobile)</label>
					      <input type="text" class="form-control" name="TEL;type=CELL" id="TEL;type=CELL" placeholder="Cell">
					    </div>
					    <div class="col-xs-6 col-sm-12">
					      <label class="control-label" for="EMAIL;type=WORK">Email:</label>
					      <div class="control-group" id="EMAIL;type=WORK">
					        <div class="controls">
					          <div class="entry input-group form-group">
					            <span class="input-group-addon">@</span>
					            <input class="form-control" name="EMAIL;type=WORK" placeholder="add email" type="text">                  
					          </div>
					        </div>
					      </div>
					     <!--       
					      <label class="control-label" for="EMAIL;type=HOME">Email (private):</label>
					      <div class="control-group" id="EMAIL;type=HOME">
					        <div class="controls">
					          <div class="entry input-group form-group">
					            <span class="input-group-addon">@</span>
					            <input class="form-control" name="EMAIL;type=HOME" placeholder="add email" type="text">                  
					          </div>
					        </div>
					      </div>
					      -->			      
					    </div>
					    <br>
					    <div class="form-group col-xs-12 col-sm-12">
					    <label>Social profiles might not work on every device e.g. iOS 11 can't handle it</label>
					      <label for="ORG" class="control-lable">Twitter</label>
					      <input type="text" class="form-control" name="X-SOCIALPROFILE;type=twitter" id="X-SOCIALPROFILE;type=twitter:" placeholder="Twitter">
					    </div> 
					    <div class="form-group col-xs-12 col-sm-12">
					      <label for="ORG" class="control-lable">LinkedIn</label>
					      <input type="text" class="form-control" name="X-SOCIALPROFILE;type=linkedin" id="X-SOCIALPROFILE;type=linkedIn:" placeholder="LinkedIn">
					    </div> 			    
					</div>
				</div> <!--row-->
			    <br> 
			   	<button class="" id="createQR" type="submit">Create QR-Code</button>
			</div><!--lass="tab-pane" id="singleQr"-->
		 
			<div class="tab-pane" id="multipleQr" role="tabpanel">
			  	<div class="row" >
			  		<div class="col-xs-12 col-sm-12">
			  			<div class="input-area" id="input-local">							
							<div class="text-center">
								Choose one or more csv files to parse and generate QR codes.
								Please be aware of the mandatory formatting of the csv file.
								Sample files:<br>
								<br>
								<a href="example/example.csv"><i class="fas fa-download"></i> Example file</a>
							</div>
							<br>
							<br>
							<input type="file" id="files" multiple>
							
						</div>
			    	</div>		   
				</div> <!--row-->

			    <br> 
			   	<button class="" id="parseCreateQR" type="submit">Create and Download QR-Codes</button>      
			 </div> <!--lass="tab-pane" id="multipleQr"-->
		</div><!--class="tab-content"-->


 
		   <!--</form>-->
			<br>
			<br>

			<div class="hidden col-xs-6 col-sm-6" id="qrCode">   
			  <canvas id="qrcode-canvas" style="padding:1em; background-color:#E8E8E8"></canvas>
						<svg id="qrcode-svg" style="width:30em; height:30em; padding:1em; background-color:#E8E8E8">
							<rect width="100%" height="100%" fill="#FFFFFF" stroke-width="0"></rect>
							<path d="" fill="#000000" stroke-width="0"></path>
						</svg>
				<br>		
				<button type="button" class="btn btn-info" id="svgDownload" onclick="downloadSVG()">Download as SVG</button>
			</div>
			<br>

			<button type="button" class="btn btn-info" data-toggle="collapse" data-target="#expertSettings">Expert Settings</button>

			<div id="expertSettings" class="collapse">

				<div class="">
					<br>
					<strong>CSV parser settings:</strong>
					<label>
						<input type="checkbox" id="stream"> Stream
						<dfn>Results are delivered row by row to a step function. Use with large inputs that would crash the browser.</dfn>
					</label>

					<label>
						<input type="checkbox" id="worker"> Worker thread
						<dfn>Uses a separate thread so the web page doesn't lock up.</dfn>
					</label>

					<label>
						<input type="checkbox" id="header" checked> Header row
						<dfn>Keys data by field name rather than an array.</dfn>
					</label>

					<label>
						<input type="checkbox" id="dynamicTyping"> Dynamic typing
						<dfn>Turns numeric data into numbers and true/false into booleans.</dfn>
					</label>

					<label>
						<input type="checkbox" id="skipEmptyLines" checked> Skip empty lines
						<dfn>By default, empty lines are parsed; check to skip.</dfn>
					</label>
				</div>
				<br>
				<table class="noborder"  style="width:100%">
					<tbody>			
						<tr>
							<td><strong>QR Code settings:</strong></td>
							<td>
									
							</td>
						</tr>
						<tr>
							<td><strong>Error correction:</strong></td>
							<td>
								<input type="radio" name="errcorlvl" id="errcorlvl-low" onchange="redrawQrCode();" checked="checked"><label for="errcorlvl-low">Low</label>
								<input type="radio" name="errcorlvl" id="errcorlvl-medium" onchange="redrawQrCode();"><label for="errcorlvl-medium">Medium</label>
								<input type="radio" name="errcorlvl" id="errcorlvl-quartile" onchange="redrawQrCode();"><label for="errcorlvl-quartile">Quartile</label>
								<input type="radio" name="errcorlvl" id="errcorlvl-high" onchange="redrawQrCode();"><label for="errcorlvl-high">High</label>
							</td>
						</tr>
						<tr>
							<td>Output format:</td>
							<td>
								<input type="radio" name="output-format" id="output-format-bitmap" onchange="redrawQrCode();" checked="checked"><label for="output-format-bitmap">Bitmap</label>
								<input type="radio" name="output-format" id="output-format-vector" onchange="redrawQrCode();"><label for="output-format-vector">Vector</label>
							</td>
						</tr>
						<tr>
							<td>Border:</td>
							<td><input type="number" value="4" min="0" max="100" step="1" id="border-input" style="width:4em" oninput="redrawQrCode();"> modules</td>
						</tr>
						<tr id="scale-row">
							<td>Scale:</td>
							<td><input type="number" value="8" min="1" max="30" step="1" id="scale-input" style="width:4em" oninput="redrawQrCode();"> pixels per module</td>
						</tr>
						<tr>
							<td>Version range:</td>
							<td>Minimum = <input type="number" value="1" min="1" max="40" step="1" id="version-min-input" style="width:4em" oninput="handleVersionMinMax('min');">, maximum = <input type="number" value="40" min="1" max="40" step="1" id="version-max-input" style="width:4em" oninput="handleVersionMinMax('max');"></td>
						</tr>
						<tr>
							<td>Mask pattern:</td>
							<td><input type="number" value="-1" min="-1" max="7" step="1" id="mask-input" style="width:4em" oninput="redrawQrCode();"> (−1 for automatic, 0 to 7 for manual)</td>
						</tr>
						<tr>
							<td>Boost ECC:</td>
							<td><input type="checkbox" checked="checked" id="boost-ecc-input" onchange="redrawQrCode();"><label for="boost-ecc-input">Increase <abbr title="error-correcting code">ECC</abbr> level within same version</label></td>
						</tr>
						<tr id="vCard_text">
							<td>vCard code:</td>
							<td>
								<textarea id="vCard-output" readonly="readonly" style="width:100%; max-width:30em; height:10em; font-family:monospace"></textarea>
							</td>
						</tr>
						
					</tbody>
				</table>
			</div> <!--expertSetting-->

		</div> <!--contentArea-->
		  
		<footer class="footer ">
		  <p>based on Project Nayuki QR Code generator library (JavaScript) and Papa Parse for CSV parsing</p>
		</footer>
	</div>	



</body>
<script type="text/javascript">

/*$(document).ready(function() {  
});*/

var qr;
var border; 
var fullName;

//this function creates the qr code based on the provided data
function redrawQrCode(vCardData) {
  var jsonData = {};
  //check whether the function get call with data handover
  //if no data is provided with the function call the form fields get checked
  //if data is provided with the function call we work with the provided data
  if (!vCardData) {
    var vCard = "BEGIN:VCARD\r\nVERSION:3.0\r\nN:"+document.getElementById("LastN").value+";"+document.getElementById("FirstN").value+";;"+document.getElementById("title").value+";";
    fullName = document.getElementById("title").value+" "+document.getElementById("FirstN").value+" "+document.getElementById("LastN").value;
    vCard += "\r\nFN:;;"+fullName;
    if (document.getElementById("address_street").value != "") {
      var address = document.getElementById("address_street").value+";"+document.getElementById("address_city").value+";;"+document.getElementById("address_zip").value;
      vCard += "\r\nADR;type=WORK:"+address;
    }
      $('.form-control').each( function() {
        console.log("checking input fields");
        //Only work with field which are not empty
        if (this.value != "" && this.name !="FirstN" && this.name !="LastN" && this.name !="title" && this.name !="address_street" && this.name !="address_city" && this.name !="address_zip") {
          jsonData[this.name] = this.value;
          vCard += "\r\n"+this.name+":"+this.value;
        }
      });
      var data = JSON.stringify(jsonData);
      console.log("data "+data);
    vCard += "\r\nEND:VCARD";
    console.log(vCard);
    document.getElementById("vCard-output").value = vCard;
  } else {vCard = vCardData};

  // Returns a QrCode.Ecc object based on the radio buttons in the HTML form.
  function getInputErrorCorrectionLevel() {
    if (document.getElementById("errcorlvl-medium").checked)
      return qrcodegen.QrCode.Ecc.MEDIUM;
    else if (document.getElementById("errcorlvl-quartile").checked)
      return qrcodegen.QrCode.Ecc.QUARTILE;
    else if (document.getElementById("errcorlvl-high").checked)
      return qrcodegen.QrCode.Ecc.HIGH;
    else  // In case no radio button is depressed
      return qrcodegen.QrCode.Ecc.LOW;
  }

  var bitmapOutput = document.getElementById("output-format-bitmap").checked;
  // Reset output images in case of early termination
  var canvas = document.getElementById("qrcode-canvas");
  var svg = document.getElementById("qrcode-svg");
  canvas.style.display = "none";
  svg.style.display = "none";
  //Generate QR-Code
  var text = vCard; //vCard is ether filled with data during the function call or by collecting the data form the form fields
  var ecl = getInputErrorCorrectionLevel();
  var segs = qrcodegen.QrSegment.makeSegments(text);
  var minVer = parseInt(document.getElementById("version-min-input").value, 10);
  var maxVer = parseInt(document.getElementById("version-max-input").value, 10);
  var mask = parseInt(document.getElementById("mask-input").value, 10);
  var boostEcc = document.getElementById("boost-ecc-input").checked;
  qr = qrcodegen.QrCode.encodeSegments(segs, ecl, minVer, maxVer, mask, boostEcc);

  // Draw image output
  border = parseInt(document.getElementById("border-input").value, 10);
  if (border < 0 || border > 100)
    return;
  if (bitmapOutput) {
    var scale = parseInt(document.getElementById("scale-input").value, 10);
    if (scale <= 0 || scale > 30)
      return;
    qr.drawCanvas(scale, border, canvas);
    canvas.style.removeProperty("display");
  } else {
    var code = qr.toSvgString(border);
    svg.setAttribute("viewBox", / viewBox="([^"]*)"/.exec(code)[1]);
    svg.querySelector("path").setAttribute("d", / d="([^"]*)"/.exec(code)[1]);
    svg.style.removeProperty("display");
  }
};

//in addion to showing the Qr Code in the browser, we offer a download function
function downloadSVG() {
  var svgData = qr.toSvgString(border);
  var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
  var svgUrl = URL.createObjectURL(svgBlob);
  var downloadLink = document.createElement("a");
  downloadLink.href = svgUrl;
  downloadLink.download = "QR_Code_"+fullName+".svg";
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}



//Beside filling the form with data we give the user the possiblity to use a csv file as input
//CSV parsing
var firstRun = true;
var start, end, firstError;

//defintion of the function which gets called when the file is parsed sucessfully
function completeFn(results)
    {
      end = Date.now();

      if (results && results.errors)
      {
        if (results.errors)
        {
          errorCount = results.errors.length;
          firstError = results.errors[0];
        }
        if (results.data && results.data.length > 0)
          rowCount = results.data.length;
      }

      printStats("Parse complete");
      console.log("    Results:", results);

      ////////////////
      //creating the vCard conform text based on the provied data
      for (var x=0; x < results.data.length; x++) {
        var vCardfromCSV = "BEGIN:VCARD\r\nVERSION:3.0\r\nN:"+results.data[x].Lastname+";"+results.data[x].Firstname+";;"+results.data[x].Title+";";
        fullName = results.data[x].Title+" "+results.data[x].Firstname+" "+results.data[x].Lastname;
        vCardfromCSV += "\r\nFN:;;"+fullName;
        if (results.data[x].Street != "" && results.data[x].Street != undefined) {
          var address = results.data[x].Street+";"+results.data[x].City+";;"+results.data[x].Zip;
          vCardfromCSV += "\r\nADR;type=WORK:"+address;
        }
        if (results.data[x].Jobtitle) {
          vCardfromCSV += "\r\nTITLE:"+results.data[x].Jobtitle;
        }
        if (results.data[x].Company) {
          vCardfromCSV += "\r\nORG:"+results.data[x].Company;
        }
        if (results.data[x].Website) {
          vCardfromCSV += "\r\nURL:"+results.data[x].Website;
        }
        if (results.data[x].Landline) {
          vCardfromCSV += "\r\nTEL;type=WORK:"+results.data[x].Landline;
        }
        if (results.data[x].Mobile) {
          vCardfromCSV += "\r\nTEL;type=CELL:"+results.data[x].Mobile;
        }
        if (results.data[x].Email ) {
          vCardfromCSV += "\r\nEMAIL;type=WORK:"+results.data[x].Email;
        }
        if (results.data[x].Twitter ) {
          vCardfromCSV += "\r\nX-SOCIALPROFILE;type=twitter:"+results.data[x].Twitter;
        }
        if (results.data[x].LinkedIn ) {
          vCardfromCSV += "\r\nX-SOCIALPROFILE;type=linkedin:"+results.data[x].LinkedIn;
        }
        vCardfromCSV += "\r\nEND:VCARD";
        console.log("vCardfromCSV:      "+vCardfromCSV);
        redrawQrCode(vCardfromCSV);
        downloadSVG();
      };
      ///////////////
    }


function errorFn(err, file)
    {
      end = Date.now();
      console.log("ERROR:", err, file);
    }

//the parser can be configured
//this function builds the config object based in the setting in the experts section on the frontend
function buildConfig()
    {
      return {
        header: $('#header').prop('checked'),
        dynamicTyping: $('#dynamicTyping').prop('checked'),
        skipEmptyLines: $('#skipEmptyLines').prop('checked'),
        step: $('#stream').prop('checked') ? stepFn : undefined,
        worker: $('#worker').prop('checked'),
        complete: completeFn,
        error: errorFn,
      };
    }

function printStats(msg)
    {
      if (msg)
        console.log(msg);
        console.log("       Time:", (end-start || "(Unknown; your browser does not support the Performance API)"), "ms");
        console.log("  Row count:", rowCount);
      if (stepped)
        console.log("    Stepped:", stepped);
        console.log("     Errors:", errorCount);
      if (errorCount)
        console.log("First error:", firstError);
    }

//The actuall csv parsing
//Convert CSV to JSON
$('#parseCreateQR').click(function(){
    if ($(this).prop('disabled') == "true")
      return;

    stepped = 0;
    rowCount = 0;
    errorCount = 0;
    firstError = undefined;

    var config = buildConfig();

    // Allow only one parse at a time
    $(this).prop('disabled', true);

    if (!firstRun)
      console.log("--------------------------------------------------");
    else
      firstRun = false;

    //USING JQUERY TO SELECT FILES
    $('#files').parse({
      // base config to use for each file
      config: config,
      before: function(file, inputElem)
      {
        // executed before parsing each file begins;
        // what you return here controls the flow
        start = Date.now();
        console.log("Parsing file...", file);
      },
      error: function(err, file)
      {
        // executed if an error occurs while loading the file,
        // or if before callback aborted for some reason
        console.log("ERROR:", err, file);
        firstError = firstError || err;
        errorCount++;
      },
      complete: function()
      {
        // executed after all files are complete
        end = Date.now();
        printStats("Done with all files");
        // Reactivate button
         $('#parseCreateQR').prop('disabled', false);
      }
    });
});


$("#createQR").on("click", function(){
  redrawQrCode(); 
  document.getElementById("qrCode").classList.remove("hidden");
}); 

$("#navMultiQr").on("click", function(){
  document.getElementById("qrCode").classList.add("hidden");
  document.getElementById("vCard-output").value = "";
}); 


</script>
</html>